// DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const sticker = document.getElementById('premium-sticker');
const adArea = document.getElementById('ad-area');
const statusText = document.getElementById('status-text');

const btnBeauty = document.getElementById('btn-beauty');
const btnPremium = document.getElementById('btn-premium');
const btnShutter = document.getElementById('btn-shutter');

// ìƒíƒœ ë³€ìˆ˜
let isBeautyMode = false;
let isPremiumMode = false;

// 1. ì¹´ë©”ë¼ ì‹¤í–‰
async function initCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user' },
            audio: false
        });
        video.srcObject = stream;
    } catch (err) {
        alert("ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
    }
}

// 2. ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ê°ì§€ ë¡œì§ (í•µì‹¬)
function checkConnection() {
    if (navigator.onLine) {
        // [ì˜¨ë¼ì¸]
        statusText.innerText = "ğŸŸ¢ ì˜¨ë¼ì¸: í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥ & ê´‘ê³  í™œì„±";
        adArea.classList.remove('hidden'); // ê´‘ê³  ë³´ì´ê¸°
        btnPremium.disabled = false;       // í”„ë¦¬ë¯¸ì—„ ë²„íŠ¼ ì ê¸ˆ í•´ì œ
    } else {
        // [ì˜¤í”„ë¼ì¸]
        statusText.innerText = "ğŸ”´ ì˜¤í”„ë¼ì¸: ê¸°ë³¸ ê¸°ëŠ¥ë§Œ ê°€ëŠ¥";
        adArea.classList.add('hidden');    // ê´‘ê³  ìˆ¨ê¸°ê¸°
        btnPremium.disabled = true;        // í”„ë¦¬ë¯¸ì—„ ë²„íŠ¼ ì ê¸ˆ
        
        // ë§Œì•½ ìŠ¤í‹°ì»¤ ì“°ê³  ìˆì—ˆë‹¤ë©´ ë„ê¸°
        if (isPremiumMode) {
            isPremiumMode = false;
            sticker.classList.add('hidden');
            btnPremium.classList.remove('premium-active');
        }
    }
}

// 3. ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
btnBeauty.addEventListener('click', () => {
    isBeautyMode = !isBeautyMode;
    if (isBeautyMode) {
        video.classList.add('filter-beauty');
        btnBeauty.classList.add('active-btn');
    } else {
        video.classList.remove('filter-beauty');
        btnBeauty.classList.remove('active-btn');
    }
});

btnPremium.addEventListener('click', () => {
    // í˜¹ì‹œë¼ë„ ì˜¤í”„ë¼ì¸ì¸ë° ëˆŒë €ì„ ê²½ìš° ë°©ì–´
    if (!navigator.onLine) {
        alert("ì¸í„°ë„· ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤!");
        return;
    }

    isPremiumMode = !isPremiumMode;
    if (isPremiumMode) {
        sticker.classList.remove('hidden');
        btnPremium.classList.add('premium-active');
    } else {
        sticker.classList.add('hidden');
        btnPremium.classList.remove('premium-active');
    }
});

// 4. ì‚¬ì§„ ì´¬ì˜ ë° ì €ì¥
btnShutter.addEventListener('click', () => {
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // ê±°ìš¸ ëª¨ë“œ ì ìš© (ì¢Œìš° ë°˜ì „)
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);

    // ë½€ìƒ¤ì‹œ í•„í„° ì ìš© (ì €ì¥ë˜ëŠ” ì‚¬ì§„ì—ë„ í•„í„° ë¨¹ì´ê¸°)
    if (isBeautyMode) {
        ctx.filter = 'brightness(1.1) contrast(0.95) saturate(1.1) blur(1px)';
    }

    // ë¹„ë””ì˜¤ í™”ë©´ ê·¸ë¦¬ê¸°
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // í•„í„° í•´ì œ (ìŠ¤í‹°ì»¤ì—ëŠ” í•„í„° ì•ˆ ë¨¹ê²Œ)
    ctx.filter = 'none';

    // í”„ë¦¬ë¯¸ì—„ ìŠ¤í‹°ì»¤ ê·¸ë¦¬ê¸° (í™œì„±í™” ìƒíƒœë¼ë©´)
    if (isPremiumMode) {
        // ìº”ë²„ìŠ¤ ì¢Œí‘œê³„ ë³µêµ¬ ë° ì¤‘ì•™ ì •ë ¬ ê³„ì‚°
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.scale(-1, 1); // ê¸€ìëŠ” ë‹¤ì‹œ ë’¤ì§‘ì–´ì•¼ ì œëŒ€ë¡œ ë³´ì„
        ctx.font = "150px serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("ğŸ±", 0, 0);
    }

    // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
    const link = document.createElement('a');
    link.download = `photo_${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
});

// 5. ì´ë²¤íŠ¸ ë“±ë¡ ë° ì‹œì‘
window.addEventListener('online', checkConnection);
window.addEventListener('offline', checkConnection);

initCamera();
checkConnection(); // ì‹œì‘í•  ë•Œ ìƒíƒœ ì²´í¬
